import{a9 as z,a4 as H,i as f,h as i,ab as R,an as V,al as y,r as l,x as K,u as W,a as O,b as G,ao as J,j as e,ad as r,ae as w,a5 as x,af as Q,B as v,ag as C,f as X,aj as Y,ah as Z,k as ee,H as te}from"./index-DTYnK1X0.js";const se=z("biling/createTableBiling",async({data:m,tableid:b},{signal:g,dispatch:p})=>{try{const s=H.CancelToken.source();g.addEventListener("abort",()=>s.cancel("Operation canceled by the user."));const d=await f.createTableBiling(m,s.token);return i.success("Successfully created"),console.log(d,"res"),d.data}catch(s){i.error("Ошибка сервера"),console.log(s)}finally{localStorage.removeItem("table_key"),localStorage.removeItem("session_key");const s=R();localStorage.getItem("table_key")||p(V({data:{session_key:`${s}`,menu_table:Number(b),promo_code:!0,discount_amount:0}})).then(n=>{console.log(n),p(y({id:Number(localStorage.getItem("table_key"))}))})}}),{Option:S}=w,ae=()=>{var P,T;const[m,b]=l.useState(""),[g,p]=l.useState(0),[s,d]=l.useState(!1),[n,j]=l.useState(0),{tableid:u}=K(),[M,A]=l.useState("bankCard"),o=W(),{data:_}=O(t=>t.user),h=(_==null?void 0:_.loyalty_points)||0,c=O(t=>t.tableCart.data),F=G();l.useEffect(()=>{o(y({id:Number(localStorage.getItem("table_key"))})),o(J({id:Number(u)}))},[o]);const $=t=>{A(t)},E=t=>{d(t.target.checked),t.target.checked||j(0)},U=t=>{const a=Number(t.target.value);a>h?(i.error(`Вы не можете потратить больше чем ${h} баллов`),j(h)):j(a)},q=async t=>{try{await f.deleteTableOrderItemById(t).then(()=>{o(ee(t)),o(y({id:Number(localStorage.getItem("table_key"))})),i.success("Товар успешно удалён из корзины")})}catch(a){console.log(a)}},k=(((P=c.items)==null?void 0:P.reduce((t,a)=>t+parseFloat(a.product.price)*a.quantity,0))||0)-g-n,N=k*.15,D=async t=>{const a=localStorage.getItem("user_id")?{session_key:localStorage.getItem("session_key"),menu_table:Number(u),promo_code:!0,discount_amount:0,user_id:Number(localStorage.getItem("user_id")),...t,points:n}:{session_key:localStorage.getItem("session_key"),menu_table:Number(u),promo_code:!0,discount_amount:0,...t,points:n};o(se({data:a,tableid:Number(u)})).then(I=>{var B;F(`/table/${u}/code/${(B=I==null?void 0:I.payload)==null?void 0:B.payment_code}`)})},L=async()=>{try{const t=await f.applyPromoCodeTable({session_key:localStorage.getItem("session_key"),promo_code:m});p(t.data.discount_amount),i.success(t.data.success)}catch{i.error("Не удалось применить промо-код")}finally{o(y({id:Number(localStorage.getItem("table_key"))}))}};return e.jsxs("div",{className:"order-container",children:[e.jsx("div",{className:"he",children:e.jsx("div",{className:"personal-info-section",children:e.jsxs(r,{onFinish:D,layout:"vertical",children:[e.jsx(r.Item,{initialValue:"bankCard",label:"Метод оплаты",name:"payment_method",children:e.jsxs(w,{defaultValue:"bankCard",onChange:$,children:[e.jsx(S,{value:"bankCard",children:"Банковская карта"}),e.jsx(S,{value:"cash",children:"Наличные"}),e.jsx(S,{value:"eWallet",children:"Электронный кошелек"})]})}),M==="cash"&&e.jsx(r.Item,{label:"Сдача с",name:"client_delivery",children:e.jsx(x,{placeholder:"Введите сумму для сдачи"})}),e.jsx(r.Item,{label:"Комментарий к заказу",name:"note",children:e.jsx(x.TextArea,{rows:3,placeholder:"Укажите тут дополнительную информацию для курьера"})}),e.jsx(r.Item,{children:e.jsx(Q,{checked:s,onChange:E,children:"Потратить баллы"})}),s&&e.jsx(r.Item,{label:`Доступно баллов: ${h}`,children:e.jsx(x,{type:"number",value:n,onChange:U,max:h,placeholder:"Количество баллов"})}),e.jsx(r.Item,{children:e.jsx(v,{type:"primary",htmlType:"submit",block:!0,disabled:((T=c.items)==null?void 0:T.length)===0,children:"Оформить заказ"})})]})})}),e.jsxs("div",{className:"order-summary-section he",children:[e.jsxs("div",{className:"",children:[e.jsx("h2",{children:"Корзина"}),e.jsx(C,{itemLayout:"horizontal",dataSource:c.items,renderItem:t=>e.jsx(C.Item,{actions:[e.jsxs("div",{className:"rightBar",children:[e.jsx(v,{onClick:()=>q(t.id),style:{width:"32px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0px 0px 0px 7px"},type:"text",icon:e.jsx(X,{style:{color:"red"}})}),e.jsx(Y,{record:t})]})],children:e.jsx(C.Item.Meta,{avatar:e.jsx(Z,{shape:"square",size:"large",style:{height:"100px",width:"100px"},src:t.product.iiko_image}),title:t.product.title,description:e.jsxs("div",{children:[e.jsx("p",{children:t.product.description}),e.jsxs("span",{style:{color:"red"},children:[parseFloat(t.product.price)*t.quantity," c"]})]})})})})]}),e.jsx("br",{}),c.discount_amount>1?"":e.jsxs("div",{className:"promo-code-section",children:[e.jsx("h3",{children:"Введите промо-код:"}),e.jsx(x,{placeholder:"Введите промо-код",value:m,onChange:t=>b(t.target.value),style:{marginBottom:"10px"}}),e.jsx(v,{type:"primary",onClick:L,block:!0,children:"Применить промо-код"})]}),e.jsx("br",{}),e.jsxs("h3",{children:["Итого: ",k+N," c"]}),e.jsxs("div",{className:"order-details",children:[e.jsxs("p",{children:["Стоимость товаров: ",k+c.discount_amount," c"]}),e.jsxs("p",{children:["Обслуживание 15%: ",N," c "]}),e.jsxs("p",{children:["Скидка: ",c.discount_amount," c "]})]})]})]})},re=()=>e.jsxs("div",{children:[e.jsx(te,{children:e.jsx("title",{children:"Mnogosushi | Оформление"})}),e.jsx(ae,{})]});export{re as default};
